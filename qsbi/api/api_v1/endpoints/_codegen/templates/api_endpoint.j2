from fastapi import APIRouter, Query, HTTPException, Request, Depends, Security
from typing import Optional, Dict

import qsbi.api.schemas.base
import qsbi.api.schemas.{{ module }} as schema
import qsbi.api.crud as crud
import qsbi.api.security.deps as auth

router = APIRouter()

## CREATE
@router.post("", status_code=201, response_model=schema.{{ classname }})
async def create_{{ module }}(
        *,
        {{ module }}_in: schema.{{ classname }}Create,
        sess: crud.CRUDSession = Depends(crud.get_session),
        curr_user = Security(auth.get_current_active_user, scopes=["create"]),
        ) -> schema.{{ classname }}:
    """
    create a new {{ module }}
    """
    {{ module }} = await crud.{{ module }}.create(sess, {{ module }}_in)
    return {{ module }}

## READ
@router.get("/list", status_code=200, response_model=schema.{{ classname }}Seq)
async def list_{{ module }}s(
        *,
        skip: Optional[int] = 0,
        limit: Optional[int] = 100,
        sess: crud.CRUDSession = Depends(crud.get_session),
        curr_user = Security(auth.get_current_active_user, scopes=["read"]),
        ) -> schema.{{ classname }}Seq:
    """
    list all {{ module }}s
    """
    {{ module }}s = await crud.{{ module }}.list(sess, skip, limit)
    return {"results": {{ module }}s}

@router.post("/search", status_code=200, response_model=schema.{{ classname }}Seq)
async def search_{{ module }}s(
        *,
        {{ module }}_in: schema.{{ classname }}Read,
        limit: Optional[int] = 100,
        sess: crud.CRUDSession = Depends(crud.get_session),
        curr_user = Security(auth.get_current_active_user, scopes=["read"]),
        ) -> schema.{{ classname }}Seq:
    """
    search {{ module }}s
    """
    {{ module }}s = await crud.{{ module }}.search(sess, {{ module }}_in, limit)
    return {"results": {{ module }}s}

{% for attr in get_by_attrs -%}
@router.get("/{{ attr.name }}/{{'{'}}{{ attr.name }}{{'}'}}", status_code=200, response_model=schema.{{ classname }})
async def get_{{ module }}_by_{{ attr.name }}(
        *,
        {{ attr.name }}: {{ attr.type }},
        sess: crud.CRUDSession = Depends(crud.get_session),
        curr_user = Security(auth.get_current_active_user, scopes=["read"]),
        ) -> Optional[schema.{{ classname }}]:
    """
    get {{ module }} by {{ attr.name }}
    """
    result = await crud.{{ module }}.get_by(sess, '{{ attr.name }}', {{ attr.name }})
    if not result:
        raise HTTPException(
            status_code=404, detail=f"{{ classname }} with {{ attr.name }} {{'{'}}{{ attr.name }}{{'}'}} not found"
        )
    return result
  
{% endfor -%}

@router.get("/count", status_code=200, response_model=qsbi.api.schemas.base.CountResult)
async def count_{{ module }}s(
        *,
        sess: crud.CRUDSession = Depends(crud.get_session),
        curr_user = Security(auth.get_current_active_user, scopes=["login"]),
        ) -> qsbi.api.schemas.base.CountResult:
    """
    count all {{ module }}s
    """
    count = await crud.{{ module }}.count(sess)
    return {"count": count}

## UPDATE
@router.put("", status_code=201, response_model=schema.{{ classname }})
async def update_{{ module }}(
        *,
        {{ module }}_in: schema.{{ classname }}Update,
        sess: crud.CRUDSession = Depends(crud.get_session),
        curr_user = Security(auth.get_current_active_user, scopes=["update"]),
        ) -> Optional[schema.{{ classname }}]:
    """
    update existing {{ module }}
    """
    result = await crud.{{ module }}.update(sess, {{ module }}_in)
    if not result:
        raise HTTPException(
            status_code=404, detail=f"{{ classname }} {{'{'}}{{ module }}_in{{'}'}} not found"
        )
    return result

## DELETE
@router.delete("", status_code=200, response_model=schema.{{ classname }}Dict)
async def delete_{{ module }}(
        *,
        {{ module }}_in: schema.{{ classname }}Delete,
        sess: crud.CRUDSession = Depends(crud.get_session),
        curr_user = Security(auth.get_current_active_user, scopes=["delete"]),
	) -> Optional[Dict]:
    """
    delete one {{ module }}
    """
    result = await crud.{{ module }}.delete(sess, {{ module }}_in)
    if not result:
        raise HTTPException(
            status_code=404, detail=f"{{ classname }} {{'{'}}{{ module }}_in{{'}'}} not found"
        )
    return result
